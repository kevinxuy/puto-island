name: 🐳 Build APK with Docker

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths: ['buildozer_docker.spec']

jobs:
  build:
    name: 📱 Docker APK Build  
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🐳 Build APK using Docker
      run: |
        # Create minimal buildozer spec
        cat > buildozer.spec << 'EOF'
        [app]
        title = Puto Island
        package.name = putoisland
        package.domain = org.test
        source.dir = .
        source.include_exts = py
        version = 1.0
        requirements = python3,kivy
        orientation = portrait
        android.api = 30
        android.minapi = 21
        android.private_storage = True
        android.archs = armeabi-v7a
        [buildozer]
        log_level = 1
        EOF
        
        # Run buildozer in Docker with pre-accepted licenses
        docker run --rm -v "$PWD":/app -w /app kivy/buildozer:latest bash -c "
          echo 'Accepting all licenses...'
          yes | sdkmanager --licenses > /dev/null 2>&1 || true
          buildozer android debug
        "
        
    - name: 📱 Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: puto-island-docker-apk
        path: bin/*.apk
        retention-days: 30